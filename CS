for T5 in T5_table:
    matching_invoices_one_to_one, match_rule_one_to_one = match_one_to_one(T5, Invoice_table)

    # Process one-to-one matches
    if matching_invoices_one_to_one:
        match_type = "one-to-one"
        for invoice, rule_index in matching_invoices_one_to_one:
            description = rule_descriptions.get(rule_index)
            output_row = {column: T5[column] if column in T5 else invoice[column] for column in output_columns}
            output_row['Match Rule'] = rule_numbers.get(match_rule_one_to_one)
            output_row['Description'] = description
            output_row['Match Type'] = match_type
            output_rows_one_to_one.append(output_row)
            matched_invoices.append(invoice)

        # Remove the matched invoice from the Invoice_table
        Invoice_table = [inv_row for inv_row in Invoice_table if inv_row not in matching_invoices_one_to_one]

        unmatched_indices = unmatched_output_df[
            (unmatched_output_df['fin_record_key'] == T5['fin_record_key']) &
            (unmatched_output_df['fin_source_amt'] == T5['fin_source_amt']) &
            (unmatched_output_df['fin_debit_credit_ind'] == T5['fin_debit_credit_ind'])
        ].index

        unmatched_output_df.drop(unmatched_indices, inplace=True)

    # If no one-to-one match, try bundle match
    else:
        matching_invoices_bundle, match_rule_bundle = match_bundle(T5, Invoice_table)

        # Process bundle matches
        if matching_invoices_bundle:
            match_type = "bundle match"
            for invoice, rule_index in matching_invoices_bundle:
                description = rule_descriptions.get(rule_index)
                output_row = {column: T5[column] if column in T5 else invoice[column] for column in output_columns}
                output_row['Match Rule'] = rule_numbers.get(match_rule_bundle)
                output_row['Description'] = description
                output_row['Match Type'] = match_type
                output_rows_bundle.append(output_row)
                matched_invoices.append(invoice)

            # Remove the matched invoices from the Invoice_table
            Invoice_table = [inv_row for inv_row in Invoice_table if inv_row not in matching_invoices_bundle]

            unmatched_indices = unmatched_output_df[
                (unmatched_output_df['fin_record_key'] == T5['fin_record_key']) &
                (unmatched_output_df['fin_source_amt'] == T5['fin_source_amt'])
            ].index

            unmatched_output_df.drop(unmatched_indices, inplace=True)

        # Process unmatched transactions
        else:
            unmatched_output_row = {column: T5[column] if column in T5 else None for column in unmatched_output_columns}
            unmatched_output_rows_bundle.append(unmatched_output_row)
