import pandas as pd

# Assuming your CSV file is named 'your_file.csv'
file_path = 'your_file.csv'

# Read the CSV file into a pandas DataFrame
df = pd.read_csv(file_path)

# Separate rows with empty values in column 'W'
empty_w_rows = df[df['W'].isnull()]

# Remove rows with empty values in column 'W' from the original DataFrame
df = df.dropna(subset=['W'])

# Save the modified DataFrame and the rows with empty values to the same Excel file
with pd.ExcelWriter('output_file.xlsx', engine='xlsxwriter') as writer:
    df.to_excel(writer, sheet_name='Sheet1', index=False)
    empty_w_rows.to_excel(writer, sheet_name='Sheet2', index=False)


empty_w_rows['source_amt'] = empty_w_rows['signed_source_amt']
# Conditionally update 'signed_source_amt' based on 'trans_type_code'
empty_w_rows.loc[empty_w_rows['trans_type_code'] == 11, 'signed_source_amt'] *= -1




empty_w_rows = empty_w_rows.drop_duplicates(subset=['a', 'b'])




# Merge the two DataFrames (df and empty_w_rows) into a single DataFrame
merged_df = pd.concat([df, empty_w_rows], ignore_index=True)

# Save the merged DataFrame to an Excel file with a gap of 2 lines after sheet 1
with pd.ExcelWriter('output_file.xlsx', engine='xlsxwriter') as writer:
    merged_df.iloc[:len(df)].to_excel(writer, sheet_name='Sheet1', index=False)
    merged_df.iloc[len(df)+2:].to_excel(writer, sheet_name='Sheet1', startrow=len(df)+2, index=False)


 # Add 4 blank rows at the end of 'signed_source_amt' column
    total_rows_start = len(merged_df) + 2
    total_rows_end = total_rows_start + 4
    writer.sheets['Sheet1'].write(total_rows_start, merged_df.columns.get_loc('signed_source_amt'), '', None)
    writer.sheets['Sheet1'].write(total_rows_start + 1, merged_df.columns.get_loc('signed_source_amt'), '', None)
    writer.sheets['Sheet1'].write(total_rows_start + 2, merged_df.columns.get_loc('signed_source_amt'), '', None)
    writer.sheets['Sheet1'].write(total_rows_start + 3, merged_df.columns.get_loc('signed_source_amt'), '', None)

    # Add the sum of 'signed_source_amt' in the last row
    writer.sheets['Sheet1'].write(total_rows_end, merged_df.columns.get_loc('signed_source_amt'), 'Total', None)
    writer.sheets['Sheet1'].write_formula(total_rows_end, merged_df.columns.get_loc('signed_source_amt') + 1,
                                          f'SUM({writer.sheets["Sheet1"].get_name()}!{merged_df.columns.get_loc("signed_source_amt") + 1}:{merged_df.columns.get_loc("signed_source_amt") + 1})')




  # Calculate the sum of 'signed_source_amt' considering positive and negative values
    total_sum = merged_df['signed_source_amt'].sum()
    writer.sheets['Sheet1'].write(total_rows_end, merged_df.columns.get_loc('signed_source_amt'), 'Total', None)
    writer.sheets['Sheet1'].write(total_rows_end, merged_df.columns.get_loc('signed_source_amt') + 1, total_sum)



 # Calculate the sum of 'signed_source_amt' considering positive and negative values
    total_sum = merged_df['signed_source_amt'].sum()

    # Write the rounded sum to the Excel file with 2 decimal places
    writer.sheets['Sheet1'].write(total_rows_end, merged_df.columns.get_loc('signed_source_amt'), 'Total', None)
    writer.sheets['Sheet1'].write(total_rows_end, merged_df.columns.get_loc('signed_source_amt') + 1, round(total_sum, 2))









# Calculate the sum for the original DataFrame (df)
df_sum = df['signed_source_amt'].sum()

# Calculate the sum for the empty_w_rows DataFrame
empty_w_rows_sum = empty_w_rows['signed_source_amt'].sum()

# Calculate the total sum by adding the sums from df and empty_w_rows
total_sum = df_sum + empty_w_rows_sum

# Save the original DataFrame to an Excel file with a gap of 2 lines after sheet 1
with pd.ExcelWriter('output_file.xlsx', engine='xlsxwriter') as writer:
    df.to_excel(writer, sheet_name='Sheet1', index=False)
    empty_w_rows.to_excel(writer, sheet_name='Sheet2', index=False)

    # Add 4 blank rows at the end of 'signed_source_amt' column in Sheet1
    total_rows_start = len(df) + 2
    total_rows_end = total_rows_start + 4
    writer.sheets['Sheet1'].write(total_rows_start, df.columns.get_loc('signed_source_amt'), '', None)
    writer.sheets['Sheet1'].write(total_rows_start + 1, df.columns.get_loc('signed_source_amt'), '', None)
    writer.sheets['Sheet1'].write(total_rows_start + 2, df.columns.get_loc('signed_source_amt'), '', None)
    writer.sheets['Sheet1'].write(total_rows_start + 3, df.columns.get_loc('signed_source_amt'), '', None)

    # Write the rounded sum of 'signed_source_amt' from df to Sheet1
    writer.sheets['Sheet1'].write(total_rows_end, df.columns.get_loc('signed_source_amt'), 'Total', None)
    writer.sheets['Sheet1'].write(total_rows_end, df.columns.get_loc('signed_source_amt') + 1, round(df_sum, 2))

    # Write the rounded sum of 'signed_source_amt' from empty_w_rows to Sheet2
    writer.sheets['Sheet2'].write(total_rows_end, empty_w_rows.columns.get_loc('signed_source_amt'), 'Total', None)
    writer.sheets['Sheet2'].write(total_rows_end, empty_w_rows.columns.get_loc('signed_source_amt') + 1, round(empty_w_rows_sum, 2))

    # Write the rounded total sum to both sheets
    writer.sheets['Sheet1'].write(total_rows_end, df.columns.get_loc('signed_source_amt') + 3, 'Total', None)
    writer.sheets['Sheet1'].write(total_rows_end, df.columns.get_loc('signed_source_amt') + 4, round(total_sum, 2))
    writer.sheets['Sheet2'].write(total_rows_end, empty_w_rows.columns.get_loc('signed_source_amt') + 3, 'Total', None)
    writer.sheets['Sheet2'].write(total_rows_end, empty_w_rows.columns.get_loc('signed_source_amt') + 4, round(total_sum, 2))








import pandas as pd

# Read CSV file
input_file_path = 'your_input_file.csv'
output_matched_file_path = 'matched_df.csv'
output_unmatched_file_path = 'unmatched_df.csv'

# Read CSV into a dataframe
df = pd.read_csv(input_file_path)

# Preprocess: Remove rows with 'mcc' column value of 0
df = df[df['mcc'] != 0]

# Split into matched and unmatched dataframes
matched_df = df[df['invoice'].notnull()]
unmatched_df = df[df['invoice'].isnull()]

# Save matched and unmatched dataframes to CSV files
matched_df.to_csv(output_matched_file_path, index=False)
unmatched_df.to_csv(output_unmatched_file_path, index=False)

print("Preprocessing and Splitting Completed. Check {} and {} for the results.".format(output_matched_file_path, output_unmatched_file_path))







# Save the merged DataFrame to an Excel file with a gap of 2 lines after sheet 1
with pd.ExcelWriter('output_file.xlsx', engine='openpyxl') as writer:
    merged_df.iloc[:len(df)].to_excel(writer, sheet_name='Sheet1', index=False)
    merged_df.iloc[len(df)+2:].to_excel(writer, sheet_name='Sheet1', startrow=len(df)+2, index=False)

  # Add 4 blank rows at the end of 'signed_source_amt' column
    total_rows_start = len(merged_df) + 2
    total_rows_end = total_rows_start + 4
    writer.sheets['Sheet1']['A' + str(total_rows_start)].value = None
    writer.sheets['Sheet1']['A' + str(total_rows_start + 1)].value = None
    writer.sheets['Sheet1']['A' + str(total_rows_start + 2)].value = None
    writer.sheets['Sheet1']['A' + str(total_rows_start + 3)].value = None

    # Calculate the sum of 'signed_source_amt' considering positive and negative values
    total_sum = merged_df['signed_source_amt'].sum()
    writer.sheets['Sheet1']['A' + str(total_rows_end)].value = 'Total'
    writer.sheets['Sheet1']['B' + str(total_rows_end)].value = total_sum
